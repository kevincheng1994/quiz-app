<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>民俗調理業經絡調理 測驗系統</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            text-align: center;
            color: #2c3e50;
        }
        #view-counter {
            font-size: 0.8em;
            font-weight: normal;
            color: #7f8c8d;
            display: block;
            text-align: center;
            margin-top: -20px;
            margin-bottom: 10px;
        }        .controls {
            text-align: center;
            margin-bottom: 30px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        #show-answers-btn {
            background-color: #2ecc71;
        }
        #show-answers-btn:hover {
            background-color: #27ae60;
        }
        .question-card {
            background: #ecf0f1;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 5px;
            border-left: 5px solid #3498db;
        }
        .question-card.result-card {
             border-left: 5px solid #9b59b6;
        }
        .question-text {
            font-weight: bold;
            margin-bottom: 15px;
        }
        .options label {
            display: block;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .options input {
            margin-right: 10px;
        }
        .result {
            margin-top: 15px;
            font-weight: bold;
        }
        .correct-answer {
            color: #e74c3c;
        }
        .user-answer.correct {
            color: #27ae60;
        }
        .user-answer.incorrect {
            color: #c0392b;
            text-decoration: line-through;
        }
        .correct-label {
            color: #27ae60;
            font-weight: normal;
        }
        .correct-option-review {
            color: #27ae60;
            font-weight: bold;
        }
        .incorrect-option-review {
            color: #c0392b;
        }
        #score-container {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 30px;
            padding: 20px;
            background-color: #ecf0f1;
            border-radius: 5px;
        }

        #fixed-footer-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #fff;
            padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            text-align: center; /* Center the buttons */
            z-index: 1000;
        }

        #timer {
            position: fixed;
            top: 20px;
            right: 20px;
            font-size: 1.2em;
            font-weight: bold;
            color: #fff;
            background-color: #c0392b;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 1001;
        }

        body {
            /* Add padding to the bottom of the body to prevent content from being hidden by the fixed footer */
            padding-bottom: 70px; /* Approximate height of the fixed footer */
        }

        /* Responsive design for mobile */
        @media (max-width: 600px) {
            body {
                padding: 10px;
                padding-bottom: 80px; /* Adjust for fixed footer */
            }
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 1.8em;
            }
            button {
                padding: 10px 15px;
                font-size: 14px;
            }
            #fixed-footer-controls {
                padding: 10px;
            }
            .modal-content {
                padding: 15px 10px; /* Further reduce padding */
            }
            .modal-content h2 {
                font-size: 1.3em;
                margin-top: 0;
                margin-bottom: 15px;
            }
            .category-setting {
                align-items: flex-start;
                margin-bottom: 8px; /* Further reduce space */
            }
            .category-setting label {
                margin-right: 10px;
                word-break: break-all;
                font-size: 14px; /* Reduce font size */
            }
            .category-setting input {
                padding: 5px; /* Reduce input padding */
            }
            #total-questions-info {
                font-size: 1em;
                margin-top: 15px;
            }
            .settings-hint {
                font-size: 0.8em;
                margin-top: 10px;
            }
            .modal-buttons {
                margin-top: 15px;
            }
        }

        /* Settings Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: #fff;
            padding: 25px 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .category-setting {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .category-setting label {
            font-weight: bold;
        }
        .category-setting input {
            width: 70px;
            padding: 5px;
            text-align: right;
        }
        #total-questions-info {
            text-align: center;
            font-weight: bold;
            margin-top: 20px;
            font-size: 1.1em;
        }
        .settings-hint {
            text-align: center;
            font-size: 0.9em;
            color: #ff0000;
            margin-top: 15px;
        }

        .modal-buttons {
            margin-top: 25px;
        }

    </style>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EY94ZZFKC6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-EY94ZZFKC6');
    </script>
</head>
<body>

    <div class="modal-overlay" id="settings-modal">
        <div class="modal-content">
            <h2>測驗設定</h2>
            <div id="category-settings-container"></div>
            <div id="total-questions-info">總題數: 0</div>
            <div class="settings-hint">※ 若未設定題數，點擊開始測驗將隨機抽選 50 題 </div>
            <div class="modal-buttons" style="text-align: center;">
                <button id="start-quiz-from-settings-btn">開始測驗</button>
                <button id="cancel-settings-btn" style="background-color: #95a5a6;">取消</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>民俗調理業經絡調理 測驗系統</h2>
        <span id="view-counter"></span>
        <div id="quiz-container"></div>
        <div id="score-container" style="display: none;"></div>
        <div id="result-container"></div>
    </div>

    <div id="timer" style="display: none;"></div>

    <div id="fixed-footer-controls">
        <button id="config-quiz-btn">新測驗 / 設定</button>
        <button id="submit-btn" style="display: none;">提交答案</button>
    </div>

    <script>
        const configQuizBtn = document.getElementById('config-quiz-btn');
        const submitBtn = document.getElementById('submit-btn');
        const quizContainer = document.getElementById('quiz-container');
        const resultContainer = document.getElementById('result-container');
        const scoreContainer = document.getElementById('score-container');
        const timerDisplay = document.getElementById('timer');
        const settingsModal = document.getElementById('settings-modal');
        const categorySettingsContainer = document.getElementById('category-settings-container');
        const startQuizFromSettingsBtn = document.getElementById('start-quiz-from-settings-btn');
        const cancelSettingsBtn = document.getElementById('cancel-settings-btn');
        const totalQuestionsInfo = document.getElementById('total-questions-info');


        let allQuestions = [];
        let questionsByCategory = {};
        let currentQuizQuestions = [];
        let userAnswers = {};
        let countdownInterval;

        const categoryNames = {
            '1': '工作項目 01：職業倫理與相關法規',
            '2': '工作項目 02：民俗調理業經絡調理操作',
            '3': '工作項目 03：顧客接待與服務',
            '90006': '共同科目90006：職業安全衛生',
            '90007': '共同科目90007：工作倫理與職業道德',
            '90008': '共同科目90008：環境保護',
            '90009': '共同科目90009：節能減碳'
        };
        const categoryDisplayOrder = ['1', '2', '3', '90006', '90007', '90008', '90009'];

        // 載入題庫並解析分類
        async function loadQuestions() {
            try {
                const response = await fetch('./b00010_questions_full.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allQuestions = await response.json();
                
                // Group questions by category
                allQuestions.forEach(q => {
                    const category = q.code.split('-')[0];
                    if (!questionsByCategory[category]) {
                        questionsByCategory[category] = [];
                    }
                    questionsByCategory[category].push(q);
                });

                populateSettingsModal();
                configQuizBtn.disabled = false;
                console.log(`成功載入 ${allQuestions.length} 題題目，共 ${Object.keys(questionsByCategory).length} 個分類。`);
            } catch (error) {
                quizContainer.innerHTML = `<p style="color: red; text-align: center;">錯誤：無法載入題庫檔案 (b00010_questions_full.json)。請確認檔案存在於同一個目錄下。</p>`;
                console.error("載入題庫失敗:", error);
            }
        }

        // 填充設定面板
        function populateSettingsModal() {
            categorySettingsContainer.innerHTML = '';
            categoryDisplayOrder.forEach(category => {
                if (!questionsByCategory[category]) return; // 如果題庫中沒有該分類，則跳過

                const categorySize = questionsByCategory[category].length;
                const displayName = categoryNames[category] || `工作項目 ${category}`;
                const settingEl = document.createElement('div');
                settingEl.className = 'category-setting';
                settingEl.innerHTML = `
                    <label for="cat_${category}">${displayName}</label>
                    <input type="number" id="cat_${category}" data-category="${category}" value="0" min="0" max="${categorySize}">
                `;
                categorySettingsContainer.appendChild(settingEl);
            });
        }

        function updateTotals() {
            let total = 0;
            const inputs = categorySettingsContainer.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                total += parseInt(input.value) || 0;
            });
            totalQuestionsInfo.textContent = `總題數: ${total}`;
        }

        // 顯示設定
        function showSettings() {
            settingsModal.style.display = 'flex';
        }

        // 隱藏設定
        function hideSettings() {
            settingsModal.style.display = 'none';
        }

        // 從設定開始測驗
        function startQuizFromSettings() {
            currentQuizQuestions = [];
            const inputs = categorySettingsContainer.querySelectorAll('input[type="number"]');
            let totalQuestions = 0;

            inputs.forEach(input => {
                totalQuestions += parseInt(input.value) || 0;
            });

            // 如果使用者未設定任何題目，則觸發預設行為
            if (totalQuestions === 0) {
                totalQuestions = 50;
                const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
                currentQuizQuestions = shuffled.slice(0, 50);
            } else {
                // 根據使用者設定建立題目列表
                inputs.forEach(input => {
                    const category = input.dataset.category;
                    const count = parseInt(input.value) || 0;
                    if (count > 0 && questionsByCategory[category]) {
                        const shuffled = [...questionsByCategory[category]].sort(() => 0.5 - Math.random());
                        currentQuizQuestions.push(...shuffled.slice(0, count));
                    }
                });
                 // 再次隨機排序，讓不同分類的題目混合
                currentQuizQuestions.sort(() => 0.5 - Math.random());
            }

            hideSettings();
            startQuiz(totalQuestions);
        }

        // 開始測驗
        function startQuiz(totalQuestions) {
            // 清理之前的狀態
            userAnswers = {};
            quizContainer.innerHTML = '';
            resultContainer.innerHTML = '';
            scoreContainer.style.display = 'none';

            // 顯示題目
            currentQuizQuestions.forEach((q, index) => {
                const parts = q.question.split(/\s*([\(（][1-4][\)）])/).filter(part => part && part.trim() !== '');
                const questionText = parts[0];
                const options = [];
                for (let i = 1; i < parts.length; i += 2) {
                    if (parts[i] && parts[i+1]) {
                        options.push(parts[i].trim() + " " + parts[i+1].replaceAll(" ", "").replaceAll("。", ""));
                    }
                }
                
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                questionCard.innerHTML = `
                    <div class="question-text">${index + 1}. ${questionText}</div>
                    <div class="options" data-question-code="${q.code}">
                        ${options.map((opt, i) => `
                            <label>
                                <input type="radio" name="question_${q.code}" value="${i + 1}">
                                ${opt}
                            </label>
                        `).join('')}
                    </div>
                `;
                quizContainer.appendChild(questionCard);
            });
            
            // 監聽答案選擇
            quizContainer.addEventListener('change', (event) => {
                if (event.target.type === 'radio') {
                    const questionCode = event.target.name.replace('question_', '');
                    userAnswers[questionCode] = event.target.value;
                }
            });

            configQuizBtn.style.display = 'none';
            submitBtn.style.display = 'inline-block';
            startTimer(3600); // 固定 60 分鐘倒數
        }

        // 開始計時器
        function startTimer(duration) {
            let timer = duration;
            timerDisplay.style.display = 'block';

            countdownInterval = setInterval(() => {
                let minutes = parseInt(timer / 60, 10);
                let seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                timerDisplay.textContent = minutes + ":" + seconds;

                if (--timer < 0) {
                    clearInterval(countdownInterval);
                    alert("時間到！將自動提交答案。");
                    showAnswers(true); // 強制提交
                }
            }, 1000);
        }

        // 顯示答案

        // 顯示答案
        function showAnswers(forceSubmit = false) {
            // 二次確認
            if (!forceSubmit) {
                const unansweredCount = currentQuizQuestions.length - Object.keys(userAnswers).length;
                let confirmMessage = "確定要提交嗎？";
                if (unansweredCount > 0) {
                    confirmMessage = `您還有 ${unansweredCount} 題尚未作答，確定要提交嗎？`;
                } else {
                    confirmMessage = "測驗已全數完成，確定要提交嗎？";
                }
                if (!window.confirm(confirmMessage)) {
                    return; // 使用者取消提交
                }
            }

            clearInterval(countdownInterval); // 停止計時器
            timerDisplay.style.display = 'none'; // 隱藏計時器

            quizContainer.innerHTML = ''; // 清空測驗題目
            resultContainer.innerHTML = '<h2>詳細檢討</h2>';
            let correctCount = 0;
            const totalQuestions = currentQuizQuestions.length;
            const incorrectQuestions = [];

            currentQuizQuestions.forEach((q, index) => {
                const userAnswer = userAnswers[q.code];
                const isCorrect = userAnswer === q.answer;
                if (isCorrect) {
                    correctCount++;
                } else {
                    incorrectQuestions.push({ q, userAnswer, index });
                }
            });
            
            if (incorrectQuestions.length === 0) {
                resultContainer.innerHTML += '<h3 style="text-align: center; color: #27ae60;">恭喜您！所有題目都答對了！</h3>';
            } else {
                incorrectQuestions.forEach(({ q, userAnswer, index }) => {
                    // 從問題字串中解析選項
                    const parts = q.question.split(/\s*([\(（][1-4][\)）])/).filter(part => part && part.trim() !== '');
                    const questionText = parts[0];
                    const options = [];
                    for (let i = 1; i < parts.length; i += 2) {
                        if (parts[i] && parts[i+1]) {
                            options.push(parts[i].trim() + " " + parts[i+1].replaceAll(" ", "").replaceAll("。", ""));
                        }
                    }

                    const resultCard = document.createElement('div');
                    resultCard.className = 'question-card result-card';
                    resultCard.innerHTML = `
                        <div class="question-text">${index + 1}. ${questionText}</div>
                        <div class="options">
                            ${options.map((opt, i) => {
                                const optionValue = i + 1;
                                let optionText = opt;
                                let optionClass = '';

                                if (String(optionValue) === q.answer) {
                                    optionText += '<span class="correct-label"> (正確答案)</span>';
                                    optionClass = 'correct-option-review';
                                }
                                if (String(optionValue) === userAnswer) {
                                    optionText += '<span class="user-answer incorrect"> (您的答案)</span>';
                                    optionClass = 'incorrect-option-review'; // Overwrite if it's also the correct answer (should not happen for incorrect questions)
                                }
                                return `<div class="${optionClass}">${optionText}</div>`;
                            }).join('')}
                        </div>
                    `;
                    resultContainer.appendChild(resultCard);
                });
            }

            // 顯示分數
            const score = totalQuestions > 0 ? (correctCount / totalQuestions) * 100 : 0;
            scoreContainer.innerHTML = `本次測驗得分: ${score.toFixed(1)} / 100 (${correctCount} 答對 / ${incorrectQuestions.length} 答錯 / 共 ${totalQuestions} 題)`;
            scoreContainer.style.display = 'block';

            submitBtn.style.display = 'none';
            configQuizBtn.style.display = 'inline-block';
        }

        // 綁定事件
        configQuizBtn.addEventListener('click', showSettings);
        cancelSettingsBtn.addEventListener('click', hideSettings);
        startQuizFromSettingsBtn.addEventListener('click', startQuizFromSettings);
        submitBtn.addEventListener('click', () => showAnswers(false)); // 使用匿名函式確保參數正確
        categorySettingsContainer.addEventListener('input', updateTotals);


        async function updateViewCount() {
            const counterElement = document.getElementById('view-counter');
            if (!counterElement) return;

            try {
                const response = await fetch('https://api.counterapi.dev/v1/b00010-quiz-app/views/up');
                if (!response.ok) {
                   counterElement.textContent = '(無法取得瀏覽次數)';
                   return;
                }
                const data = await response.json();
                counterElement.textContent = `(瀏覽次數: ${data.count})`;
            } catch (error) {
                console.error("View counter failed:", error);
                counterElement.textContent = '(無法取得瀏覽次數)';
            }
        }

        // 頁面載入時，立即載入題庫
        window.onload = () => {
            configQuizBtn.disabled = true;
            loadQuestions();
            updateViewCount();
        };

    </script>
</body>
</html>
